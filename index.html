<html>
<head>
	<style type="text/css">
		#refreshing {
			display: none;
		}
	</style>
	<script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
	<script type="text/javascript">		
		var who = getQueryParam('who');
		if (!who) {
			who = 'poultree';
		}
		var apiKey = getQueryParam('key');
		var sheetId = getQueryParam('sheet');

		var CFG = {
			'poultree': {
				cell: 'B7'
			},
			'gary': {
				cell: 'C7'
			},
			'elegy': {
				cell: 'D7'
			},
			'inno': {
				cell: 'E7'
			}
		};
	
		var TABLE = 'icons';
		var AUTO_REFRESH_CELL = 'G3';
		var AUTO_REFRESH_INTERVAL = 20000;
			
		var curIcons = [''];
		var autoRefreshInterval;
		
		function updateIcon() {
			var ranges = [
				[CFG[who].cell, CFG[who].cell],
				[AUTO_REFRESH_CELL, AUTO_REFRESH_CELL]
			];
			queryCells(ranges, 
				function(values) {
					parseIcons(values);
					parseAutoRefreshState(values);
				},
				function(err) {
					console.log(err);
					toggleAutoRefresh(false);
				}
			);
		}
		
		function parseIcons(values) {
			var rows = values[0].values;
			for (var i = 0; i < Math.min(curIcons.length, rows.length); i++) {
				var icon = rows[i];
				if (icon && icon !== curIcons[i]) {
					$('#icon' + i).attr('src', icon);
					curIcons[i] = icon;
				}
			}
		}
		
		function parseAutoRefreshState(values) {
			var rows = values[1].values[0];
			var autoRefresh = rows[0] && rows[0].toLowerCase() === 'yes';
			toggleAutoRefresh(autoRefresh);
		}
		
		function toggleAutoRefresh(doAuto) {
			if (doAuto && !autoRefreshInterval) {
				console.log('Starting auto refresh');
				autoRefreshInterval = setInterval(updateIcon, AUTO_REFRESH_INTERVAL);
			}
			else if (!doAuto && autoRefreshInterval) {
				console.log('Stopping auto refresh');
				clearInterval(autoRefreshInterval);
			}
		}
		
		function queryCells(cellRanges, cb, cbErr) {
			var url = buildSpreadsheetURL(cellRanges);
			$.get(url, function(data) {
				if (data && data.valueRanges) {
					cb(data.valueRanges);
				}
				else {
					cbErr('Could not get data');
				}
			}).fail(function(err) {
				cbErr(err + '');
			});
		}
		
		function buildSpreadsheetURL(cellRanges) {
			var rangesParam = '';
			$.each(cellRanges, function(i, r) {
				if (rangesParam.length)  {
					rangesParam += '&';
				}
				rangesParam += 'ranges=' + TABLE + '!' + r[0] + ':' + r[1];
			});
			return 'https://sheets.googleapis.com/v4/spreadsheets/' + sheetId +
			'/values:batchGet/?' + rangesParam + '&key=' + apiKey;	
		}
		
		function getQueryParam(name, url) {
			if (!url) url = window.location.href;
			name = name.replace(/[\[\]]/g, "\\$&");
			var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
				results = regex.exec(url);
			if (!results) return null;
			if (!results[2]) return '';
			return decodeURIComponent(results[2].replace(/\+/g, " "));
		}
		
		$(function() {
			updateIcon();
			$('#icon0').click(function() {
				updateIcon();
			});
		});
	</script>
</head>
<body>
	<div id="icons">
		<img id="icon0"></img>
	</div>
</body>
</html>